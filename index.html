<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WhatsApp Redirect - Flight-mode based switching</title>
  <style>
    body{font-family:Arial, sans-serif; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; background:#f5f7fa;}
    .card{background:#fff; padding:20px 22px; border-radius:10px; box-shadow:0 8px 30px rgba(11,20,40,0.06); width:360px; text-align:center;}
    .muted{color:#666; font-size:13px;}
    button{padding:10px 14px; border-radius:8px; border:0; background:#007bff; color:#fff; cursor:pointer; margin-top:10px;}
    a.link{display:inline-block;margin-top:10px;color:#007bff;text-decoration:none;}
    small{display:block;margin-top:8px;color:#888;}
  </style>
</head>
<body>
  <div class="card">
    <h3>Redirecting to WhatsApp</h3>
    <div id="status" class="muted">Initializing…</div>
    <div id="current" style="margin-top:12px;font-weight:600;"></div>
    <button id="manualBtn">नया नंबर (manual)</button>
    <a id="manualLink" class="link" href="#" target="_blank">अगर automatic redirect नहीं हुआ तो यहाँ क्लिक करें</a>
    <small>यह system flight-mode (offline → online) या network-change को देखकर नया नंबर देगा.</small>
  </div>

  <script>
    /*****  User's WhatsApp links (from your list)  *****/
    const WHATSAPP_LINKS = [
      "https://api.whatsapp.com/send?phone=919144259371&text=Could%20you%20please%20introduce%20this%20job%20to%20me%20patiently%3F",
      "https://api.whatsapp.com/send?phone=918519965174&text=Could%20you%20please%20introduce%20this%20job%20to%20me%20patiently%3F",
      "https://api.whatsapp.com/send?phone=918001353832&text=Could%20you%20please%20introduce%20this%20job%20to%20me%20patiently%3F",
      "https://api.whatsapp.com/send?phone=919082101941&text=Could%20you%20please%20introduce%20this%20job%20to%20me%20patiently%3F",
      "https://api.whatsapp.com/send?phone=917600482868&text=Could%20you%20please%20introduce%20this%20job%20to%20me%20patiently%3F",
      "https://api.whatsapp.com/send?phone=917977802001&text=Could%20you%20please%20introduce%20this%20job%20to%20me%20patiently%3F",
      "https://api.whatsapp.com/send?phone=918805070782&text=Could%20you%20please%20introduce%20this%20job%20to%20me%20patiently%3F",
      "https://api.whatsapp.com/send?phone=918696682348&text=Could%20you%20please%20introduce%20this%20job%20to%20me%20patiently%3F",
      "https://api.whatsapp.com/send?phone=919262904584&text=Could%20you%20please%20introduce%20this%20job%20to%20me%20patiently%3F",
      "https://api.whatsapp.com/send?phone=917681897295&text=Could%20you%20please%20introduce%20this%20job%20to%20me%20patiently%3F",
      "https://api.whatsapp.com/send?phone=919084775905&text=Could%20you%20please%20introduce%20this%20job%20to%20me%20patiently%3F",
      // You also gave: +91 87074 32662 (plain number). If you want a link for that add below:
      "https://api.whatsapp.com/send?phone=918707432662&text=Could%20you%20please%20introduce%20this%20job%20to%20me%20patiently%3F"
    ];
    /*****************************************************/

    // localStorage keys
    const LS_KEY_IDX = "wa_assigned_idx_v1";
    const LS_KEY_AT  = "wa_assigned_at_v1"; // timestamp when assigned

    // UI elements
    const statusEl = document.getElementById("status");
    const currentEl = document.getElementById("current");
    const manualBtn = document.getElementById("manualBtn");
    const manualLink = document.getElementById("manualLink");

    // debounce guard so multiple quick network events don't cause multiple assignments
    let lastChangeAt = 0;
    const DEBOUNCE_MS = 1500;

    // helper: set UI and manual link
    function showAssigned(idx){
      const link = WHATSAPP_LINKS[idx];
      currentEl.innerText = `Assigned number #${idx+1}`;
      manualLink.href = link;
      manualLink.innerText = `Open assigned WhatsApp (#${idx+1})`;
    }

    // pick initial index: if already stored, reuse; else pick random
    function getInitialIndex(){
      const stored = localStorage.getItem(LS_KEY_IDX);
      if (stored !== null) {
        const idx = parseInt(stored,10);
        if (!Number.isNaN(idx) && idx >=0 && idx < WHATSAPP_LINKS.length) return idx;
      }
      // choose a random to start
      const r = Math.floor(Math.random() * WHATSAPP_LINKS.length);
      localStorage.setItem(LS_KEY_IDX, String(r));
      localStorage.setItem(LS_KEY_AT, String(Date.now()));
      return r;
    }

    // assign a new index different from current (cyclic next preferred)
    function assignNextIndex(){
      const now = Date.now();
      if (now - lastChangeAt < DEBOUNCE_MS) return null; // ignore if too soon
      lastChangeAt = now;

      const curRaw = localStorage.getItem(LS_KEY_IDX);
      let cur = (curRaw !== null) ? parseInt(curRaw,10) : NaN;
      if (Number.isNaN(cur) || cur<0 || cur>=WHATSAPP_LINKS.length) cur = -1;

      // choose next sequential index (preferred) so distribution is balanced
      const next = (cur + 1) % WHATSAPP_LINKS.length;
      localStorage.setItem(LS_KEY_IDX, String(next));
      localStorage.setItem(LS_KEY_AT, String(now));
      return next;
    }

    // Do redirect safely (replace history)
    function redirectToIndex(idx){
      if (idx === null) return;
      const url = WHATSAPP_LINKS[idx];
      statusEl.innerText = "Redirecting to assigned WhatsApp...";
      // small delay so UI updates
      setTimeout(()=> {
        // open in same tab
        window.location.replace(url);
      }, 250);
    }

    // Called when we detect a "flight-mode like" sequence or manual
    function onFlightToggleDetected(){
      statusEl.innerText = "Network change detected — assigning new number...";
      const newIdx = assignNextIndex();
      if (newIdx === null) {
        statusEl.innerText = "Change detected but ignored (debounce).";
        return;
      }
      showAssigned(newIdx);
      // redirect
      redirectToIndex(newIdx);
    }

    // Setup listeners for offline->online sequence
    let pendingOffline = false;

    window.addEventListener("offline", () => {
      // user went offline — likely flight-mode on (or no network)
      pendingOffline = true;
      statusEl.innerText = "Network offline detected. Waiting for reconnect...";
    });

    window.addEventListener("online", () => {
      // when online returns, if we previously saw offline, treat as flight-toggle
      if (pendingOffline) {
        pendingOffline = false;
        // small delay to allow network stabilize
        setTimeout(() => {
          onFlightToggleDetected();
        }, 600);
      } else {
        // Sometimes browsers don't fire offline; still try to detect big connection change
        statusEl.innerText = "Network online. If you toggled flight-mode, number will update.";
      }
    });

    // network information API: detect changes in connection (type/effectiveType)
    if (navigator.connection && typeof navigator.connection.addEventListener === "function") {
      navigator.connection.addEventListener("change", () => {
        statusEl.innerText = "Connection type changed (network change detected).";
        // treat this as flight-toggle only if offline->online previously seen OR if connection type changed drastically
        // To be responsive, we will assign new number on connection change as well (after debounce)
        setTimeout(() => {
          // assign new index only if the change seems significant (we'll just run assignNextIndex)
          const newIdx = assignNextIndex();
          if (newIdx !== null) {
            showAssigned(newIdx);
            redirectToIndex(newIdx);
          }
        }, 500);
      });
    }

    // Visibilitychange: sometimes mobile toggles network without firing events; use this as fallback
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        // when tab becomes visible again, check if online state changed
        // If online and last stored assignment older than a short time, do nothing
        // But if you previously saw offline, it will be handled by 'online' handler
      }
    });

    // Manual button: user can force new number (useful for testing)
    manualBtn.addEventListener("click", () => {
      statusEl.innerText = "Manual request: assigning new number...";
      const newIdx = assignNextIndex();
      if (newIdx !== null) {
        showAssigned(newIdx);
        redirectToIndex(newIdx);
      } else {
        statusEl.innerText = "Please wait a moment before trying again.";
      }
    });

    // Init on load
    (function init(){
      const idx = getInitialIndex();
      statusEl.innerText = navigator.onLine ? "Online — using assigned number." : "Currently offline — will redirect when online.";
      showAssigned(idx);
      manualLink.href = WHATSAPP_LINKS[idx];
      // auto-redirect on first load if online
      if (navigator.onLine) {
        // small delay so user sees UI
        setTimeout(()=> redirectToIndex(idx), 700);
      }
    })();

  </script>
</body>
</html>
